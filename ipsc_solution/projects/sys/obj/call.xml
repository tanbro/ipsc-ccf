<?xml version="1.0" encoding="utf-8"?>
<root>
  <FlowItem>
    <FlowID>call</FlowID>
    <FlowName>call</FlowName>
    <FlowDesc />
    <FlowVer>1.0</FlowVer>
    <CreateDate>2016-06-03T18:04:14+08:00</CreateDate>
    <ModifyDate>2016-06-27T03:17:59+08:00</ModifyDate>
    <DesignVer>2.0</DesignVer>
  </FlowItem>
  <FlowNode>
    <NodeID>1021</NodeID>
    <NodeType>SUBSTART</NodeType>
    <NodeName>子流程开始</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <AffectList>
        <varlist>
          <var>sender</var>
        </varlist>
        <varlist>
          <var>id_</var>
        </varlist>
        <varlist>
          <var>params</var>
        </varlist>
      </AffectList>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1074</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1074</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call init</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None

res_id = None
chan = None
conf_id = None

call_map = _gd_['call_map'] # chan =&gt; call_info
conf_map = _gd_['conf_map'] # res_id =&gt; call_info

call_map_r = _gd_['call_map_r'] # res_id =&gt; call_info
conf_map_r = _gd_['conf_map_r'] # res_id -&gt; conf_info

parent_call_info = None
release_delay = None
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1181</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1122</NodeID>
    <NodeType>JUDGE</NodeType>
    <NodeName>判断 operation method</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <switch>
        <case>
          <expression>method == 'call.drop'</expression>
          <ExitType>104</ExitType>
        </case>
        <case>
          <expression>method == 'call.redirect'</expression>
          <ExitType>102</ExitType>
        </case>
        <case>
          <expression>method == 'call.answer'</expression>
          <ExitType>103</ExitType>
        </case>
        <case>
          <expression>method == 'call.play_start'</expression>
          <ExitType>101</ExitType>
        </case>
        <case>
          <expression>method == 'call.play_stop'</expression>
          <ExitType>105</ExitType>
        </case>
        <case>
          <expression>method == 'call.record_start'</expression>
          <ExitType>108</ExitType>
        </case>
        <case>
          <expression>method == 'call.record_stop'</expression>
          <ExitType>109</ExitType>
        </case>
        <case>
          <expression>method == 'call.send_dtmf_start'</expression>
          <ExitType>110</ExitType>
        </case>
        <case>
          <expression>method == 'call.send_dtmf_stop'</expression>
          <ExitType>111</ExitType>
        </case>
        <case>
          <expression>method == 'call.receive_dtmf_start'</expression>
          <ExitType>112</ExitType>
        </case>
        <case>
          <expression>method == 'call.receive_dtmf_stop'</expression>
          <ExitType>113</ExitType>
        </case>
        <case>
          <expression>method == 'call.bridge_start'</expression>
          <ExitType>114</ExitType>
        </case>
        <case>
          <expression>method == 'call.bridge_stop'</expression>
          <ExitType>115</ExitType>
        </case>
        <case>
          <expression>method == 'call.conf_enter'</expression>
          <ExitType>106</ExitType>
        </case>
        <case>
          <expression>method == 'call.conf_exit'</expression>
          <ExitType>107</ExitType>
        </case>
        <case>
          <expression>method == 'call.get'</expression>
          <ExitType>116</ExitType>
        </case>
      </switch>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>104</type>
          <targetflow>
          </targetflow>
          <target>1273</target>
        </ExitPort>
        <ExitPort>
          <type>102</type>
          <targetflow>
          </targetflow>
          <target>1226</target>
        </ExitPort>
        <ExitPort>
          <type>103</type>
          <targetflow>
          </targetflow>
          <target>1845</target>
        </ExitPort>
        <ExitPort>
          <type>101</type>
          <targetflow>
          </targetflow>
          <target>1824</target>
        </ExitPort>
        <ExitPort>
          <type>105</type>
          <targetflow>
          </targetflow>
          <target>1290</target>
        </ExitPort>
        <ExitPort>
          <type>108</type>
          <targetflow>
          </targetflow>
          <target>1827</target>
        </ExitPort>
        <ExitPort>
          <type>109</type>
          <targetflow>
          </targetflow>
          <target>1599</target>
        </ExitPort>
        <ExitPort>
          <type>110</type>
          <targetflow>
          </targetflow>
          <target>1828</target>
        </ExitPort>
        <ExitPort>
          <type>111</type>
          <targetflow>
          </targetflow>
          <target>1690</target>
        </ExitPort>
        <ExitPort>
          <type>112</type>
          <targetflow>
          </targetflow>
          <target>1829</target>
        </ExitPort>
        <ExitPort>
          <type>113</type>
          <targetflow>
          </targetflow>
          <target>1747</target>
        </ExitPort>
        <ExitPort>
          <type>114</type>
          <targetflow>
          </targetflow>
          <target>1830</target>
        </ExitPort>
        <ExitPort>
          <type>115</type>
          <targetflow>
          </targetflow>
          <target>1819</target>
        </ExitPort>
        <ExitPort>
          <type>106</type>
          <targetflow>
          </targetflow>
          <target>1898</target>
        </ExitPort>
        <ExitPort>
          <type>107</type>
          <targetflow>
          </targetflow>
          <target>1348</target>
        </ExitPort>
        <ExitPort>
          <type>116</type>
          <targetflow>
          </targetflow>
          <target>1907</target>
        </ExitPort>
        <ExitPort>
          <type>100</type>
          <targetflow>
          </targetflow>
          <target>1398</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1181</NodeID>
    <NodeType>JUDGE</NodeType>
    <NodeName>判断 call in/out</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <switch>
        <case>
          <expression>(id_ is None) and (params is None)</expression>
          <ExitType>101</ExitType>
        </case>
      </switch>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>101</type>
          <targetflow>
          </targetflow>
          <target>1216</target>
        </ExitPort>
        <ExitPort>
          <type>100</type>
          <targetflow>
          </targetflow>
          <target>1232</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1398</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 invalid method</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_error(sender, id_, message='invalid method')
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1907</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 get</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		jsonrpc.send_result(sender, id_, call_info)
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1139</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 parse data</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=sender, id_, method, params = json.loads(data)</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1122</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1142</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 Delay</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=answer_time = call_info.get('answer_time')
if answer_time:
	if max_answer_seconds &lt;= now() - answer_time:
		TraceErr('max_answer_seconds(%d) expired' % max_answer_seconds)
		Hangup(chan, 603)
#
ret_val = AsynchInvoke(Delay(15000, 2, chan, -1, "BusNotifyTitle=%s" % res_id))
err, data = ret_val
if err == -8:
	Trace('call DELAY timeout')
elif err != 1:
	TraceErr('Delay error %s: %s' % (err, data))
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1143</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1143</NodeID>
    <NodeType>JUDGE</NodeType>
    <NodeName>判断 Delay returns</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <switch>
        <case>
          <expression>err == 1</expression>
          <ExitType>101</ExitType>
        </case>
        <case>
          <expression>err == -61</expression>
          <ExitType>103</ExitType>
        </case>
      </switch>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>101</type>
          <targetflow>
          </targetflow>
          <target>1139</target>
        </ExitPort>
        <ExitPort>
          <type>103</type>
          <targetflow>
          </targetflow>
          <target>1129</target>
        </ExitPort>
        <ExitPort>
          <type>100</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1192</NodeID>
    <NodeType>DIALEX</NodeType>
    <NodeName>拨号</NodeName>
    <ExtendedProperty>WorkCh=dial_chan;Dnis=to_uri;Ani=from_uri;OrDnis=;AgConnDelay=6;IsConnCh=0;RingVoice=ring_play_file;RingTimeout=max_ring_seconds;IsStopPlay=1;IsCheckDialTone=0;OutChNo=chan;OutDnis=;LinkNo=;PlayType=;CallDevGroup=;CallDev=;InteractiveMode=0;CallDevType=2;DtmfTime=10;Option=;WorkDev2=0;OutSessionID=;OutConnCh=;EndMode=1;IsM3G=0</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>6</type>
          <targetflow>
          </targetflow>
          <target>1195</target>
        </ExitPort>
        <ExitPort>
          <type>4</type>
          <targetflow>
          </targetflow>
          <target>1195</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1194</target>
        </ExitPort>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1195</target>
        </ExitPort>
        <ExitPort>
          <type>5</type>
          <targetflow>
          </targetflow>
          <target>1195</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1194</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call out initiated</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	res_id = utils.make_flow_id()
	Trace('call res_id: %s' % res_id)
	call_info = call_map[chan] = call_map_r[res_id] = {
		'id': id_,
		'res_id': res_id,
		'params': params,
		'state': 'Initiated',
		'chan': chan,
		'call_dir': 'outbound',
		'from_uri': from_uri,
		'to_uri': to_uri,
		'begin_time': now(),
		'answer_time': None,
		'end_time': None,
		'dropped_by': None,
		'reason': None,
		'cause': None,
	}
	jsonrpc.send_result(sender, id_, res_id)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1195</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1203</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1195</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.perform error</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	call_map.pop(chan, None)
	call_map_r.pop(res_id, None)
	jsonrpc.send_error(sender, id_)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1203</NodeID>
    <NodeType>JUDGE</NodeType>
    <NodeName>判断 not last_err</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <switch>
        <case>
          <expression>not bool(last_err)</expression>
          <ExitType>101</ExitType>
        </case>
      </switch>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>101</type>
          <targetflow>
          </targetflow>
          <target>1465</target>
        </ExitPort>
        <ExitPort>
          <type>100</type>
          <targetflow>
          </targetflow>
          <target>1195</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1232</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call dial parse</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	org_from_uri = params.get('from_uri')
	if bool(org_from_uri):
		user, host, port = utils.parse_sip_uri(org_from_uri)
		if user:
			from_uri = '{0}@{1}:{2}'.format(user, host, port)
		else:
			from_uri = '{1}:{2}'.format(user, host, port)
	else:
		from_uri = ''
	user, host, port = utils.parse_sip_uri(params['to_uri'])
	if user:
		to_uri = '{0}@{1}:{2}'.format(user, host, port)
	else:
		to_uri = '{1}:{2}'.format(user, host, port)
	release_delay = params.get('release_delay', 1)
	max_answer_seconds = params['max_answer_seconds']
	max_ring_seconds = params.get('max_ring_seconds', 50)
	# for SUBCALL
	parent_call_res_id = params.get('parent_call_res_id')
	if parent_call_res_id:
		parent_call_info = call_map_r[parent_call_res_id]
		if parent_call_info['state'] not in ['Idle']:
			raise RuntimeError('Can not perform method "%s" on a call whose parent call''s state is "%s"' % (method, call_info['state']))
		parent_call_info['state'] = 'Dial'
		dial_chan = parent_call_info['chan']
		ring_play_file = params.get('ring_play_file')
	else:
		parent_call_info = None
		dial_chan = GetCurrentCh()
		ring_play_file = None
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1195</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1235</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1235</NodeID>
    <NodeType>JUDGE</NodeType>
    <NodeName>判断 not last_err</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <switch>
        <case>
          <expression>not bool(last_err)</expression>
          <ExitType>101</ExitType>
        </case>
      </switch>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>101</type>
          <targetflow>
          </targetflow>
          <target>1192</target>
        </ExitPort>
        <ExitPort>
          <type>100</type>
          <targetflow>
          </targetflow>
          <target>1195</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1465</NodeID>
    <NodeType>INVOKESUB</NodeType>
    <NodeName>调子流程 call async dial</NodeName>
    <ExtendedProperty>SubFlowName=call_aync_dial;InvokeType=1;ChNo=chan;Timeout=;RunMode=0</ExtendedProperty>
    <PropertySet>
      <AffectList />
      <EffectList>
        <valuelist>
          <value>sender</value>
        </valuelist>
        <valuelist>
          <value>id_</value>
        </valuelist>
        <valuelist>
          <value>res_id</value>
        </valuelist>
      </EffectList>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1195</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>22</type>
          <targetflow>call_aync_dial</targetflow>
          <target>1000</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1216</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 inbound</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	res_id = utils.make_flow_id()
	Trace('call res_id: %s' % res_id)
	chan = GetCurrentCh()
	from_uri = 'sip:{}'.format(GetOrgCallNo())
	if GetCalledNo():
		to_uri = 'sip:{}'.format(GetCalledNo())
	else:
		to_uri = None
	params = dict(
		res_id = res_id,
		from_uri = from_uri,
		to_uri = to_uri
	)
	call_info = call_map[chan] = call_map_r[res_id] = {
		'id': id_,
		'res_id': res_id,
		'params': params,
		'state': 'Initiated',
		'chan': chan,
		'call_dir': 'inbound',
		'from_uri': from_uri,
		'to_uri': to_uri,
		'begin_time': now(),
		'answer_time': None,
		'end_time': None,
		'dropped_by': None,
		'reason': None,
		'cause': None,
	}
	jsonrpc.send_method(
		method='call.on_incoming',
		params=dict(
			res_id=res_id,
			from_uri=from_uri,
			to_uri=to_uri,
			begin_time=call_info['begin_time'],
		)
	)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1129</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1248</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1248</NodeID>
    <NodeType>JUDGE</NodeType>
    <NodeName>判断 not last_err</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <switch>
        <case>
          <expression>not bool(last_err)</expression>
          <ExitType>101</ExitType>
        </case>
      </switch>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1129</target>
        </ExitPort>
        <ExitPort>
          <type>101</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>100</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1129</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.on_released</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=try:
	call_info['end_time'] = now()
	call_info['state'] = 'Released'
	call_info['reason'], call_info['cause'] = GetCallFailReasonAndCause(chan)

	if parent_call_info:
		parent_call_info['state'] = 'Idle'

finally:
	call_map.pop(chan)
	call_map_r.pop(res_id)
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1918</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1918</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1911</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.on_released</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_method(
		method='call.on_released',
		params={
			'res_id': call_info['res_id'],
			'call_dir': call_info['call_dir'],
			'from_uri': call_info['from_uri'],
			'to_uri': call_info['to_uri'],
			'begin_time': call_info['begin_time'],
			'answer_time': call_info['answer_time'],
			'end_time': call_info['end_time'],
			'dropped_by': call_info['dropped_by'],
			'cause': call_info['cause'],
		}
	)
except IvrError as err:
	TraceErr(err)
	last_err = err

</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1912</NodeID>
    <NodeType>DELAY</NodeType>
    <NodeName>延时</NodeName>
    <ExtendedProperty>IsCheckHangup=0;Delay=release_delay * 1000;Contect=;WorkCh=;OutData=;Option=</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>5</type>
          <targetflow>
          </targetflow>
          <target>1911</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1911</target>
        </ExitPort>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1911</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1918</NodeID>
    <NodeType>JUDGE</NodeType>
    <NodeName>判断 release_delay</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <switch>
        <case>
          <expression>release_delay</expression>
          <ExitType>101</ExitType>
        </case>
      </switch>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1911</target>
        </ExitPort>
        <ExitPort>
          <type>101</type>
          <targetflow>
          </targetflow>
          <target>1912</target>
        </ExitPort>
        <ExitPort>
          <type>100</type>
          <targetflow>
          </targetflow>
          <target>1911</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1226</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 redirect</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		if call_info['call_dir'] == 'outbound':
			raise RuntimeError('Can not redirect an outbound call.')
		if call_info['state'] not in ['Initiated']:
			raise RuntimeError('Can not perform method "%s" on a call whose state is "%s"' % (method, call_info['state']))
		redirect_uri = params['redirect_uri']
		destuser, destip, destport = utils.parse_sip_uri(redirect_uri)
		ReadySipRedirect(chan, 302, destuser, destip, destport)
		jsonrpc.send_result(sender, id_)
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1129</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1129</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1837</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.answer ok return</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_result(sender, id_)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1838</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.answer error</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_error(sender, id_)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1843</NodeID>
    <NodeType>INVOKESUB</NodeType>
    <NodeName>调子流程 async answer</NodeName>
    <ExtendedProperty>SubFlowName=call_async_answer;InvokeType=1;ChNo=vch;Timeout=;RunMode=0</ExtendedProperty>
    <PropertySet>
      <AffectList />
      <EffectList>
        <valuelist>
          <value>sender</value>
        </valuelist>
        <valuelist>
          <value>id_</value>
        </valuelist>
        <valuelist>
          <value>res_id</value>
        </valuelist>
        <valuelist>
          <value>params</value>
        </valuelist>
      </EffectList>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1838</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1837</target>
        </ExitPort>
        <ExitPort>
          <type>22</type>
          <targetflow>call_async_answer</targetflow>
          <target>1000</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1845</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 NewVCh and check_state</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		if call_info['call_dir'] == 'outbound':
			raise RuntimeError('Can not answer an outbound call.')
		if call_info['state'] not in ['Initiated']:
			raise RuntimeError('Can not perform method "%s" on a call whose state is "%s"' % (method, call_info['state']))
		#
		max_answer_seconds = params['max_answer_seconds']
		release_delay = params.get('release_delay', 1)
		vch = NewVCh()
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1843</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1273</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 drop</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		if call_info['state'] in ['Answer']:
			raise RuntimeError('Can not perform method "%s" on a call whose state is "%s"' % (method, call_info['state']))
		Hangup(chan, params.get('cause', 603))
		jsonrpc.send_result(sender, id_)
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1175</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.play_start ok return</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_result(sender, id_)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1300</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.play_start error</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_error(sender, id_)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1502</NodeID>
    <NodeType>INVOKESUB</NodeType>
    <NodeName>调子流程 async play</NodeName>
    <ExtendedProperty>SubFlowName=call_async_play;InvokeType=1;ChNo=vch;Timeout=;RunMode=0</ExtendedProperty>
    <PropertySet>
      <AffectList />
      <EffectList>
        <valuelist>
          <value>sender</value>
        </valuelist>
        <valuelist>
          <value>id_</value>
        </valuelist>
        <valuelist>
          <value>res_id</value>
        </valuelist>
        <valuelist>
          <value>params</value>
        </valuelist>
      </EffectList>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1300</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1175</target>
        </ExitPort>
        <ExitPort>
          <type>22</type>
          <targetflow>call_async_play</targetflow>
          <target>1000</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1824</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 NewVCh and check_state</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		if call_info['state'] not in ['Idle']:
			raise RuntimeError('Can not perform method "%s" on a call whose state is "%s"' % (method, call_info['state']))
		#
		vch = NewVCh()
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1502</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1290</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 play stop</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		if call_info['state'] not in ['Play']:
			raise RuntimeError('Can not perform method "%s" on a call whose state is "%s"' % (method, call_info['state']))
		BreakPlayRec(call_info['async_work_ch'])
		call_info['async_work_ch'] = None
		jsonrpc.send_result(sender, id_)
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1569</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.record_start ok return</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_result(sender, id_)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1570</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.record_start error</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_error(sender, id_)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1575</NodeID>
    <NodeType>INVOKESUB</NodeType>
    <NodeName>调子流程 async record</NodeName>
    <ExtendedProperty>SubFlowName=call_async_record;InvokeType=1;ChNo=vch;Timeout=;RunMode=0</ExtendedProperty>
    <PropertySet>
      <AffectList />
      <EffectList>
        <valuelist>
          <value>sender</value>
        </valuelist>
        <valuelist>
          <value>id_</value>
        </valuelist>
        <valuelist>
          <value>res_id</value>
        </valuelist>
        <valuelist>
          <value>params</value>
        </valuelist>
      </EffectList>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1570</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1569</target>
        </ExitPort>
        <ExitPort>
          <type>22</type>
          <targetflow>call_async_record</targetflow>
          <target>1000</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1827</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 NewVCh and check_state</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		if call_info['state'] not in ['Idle']:
			raise RuntimeError('Can not perform method "%s" on a call whose state is "%s"' % (method, call_info['state']))
		#
		vch = NewVCh()
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1575</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1599</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 record stop</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		if call_info['state'] not in ['Record']:
			raise RuntimeError('Can not perform method "%s" on a call whose state is "%s"' % (method, call_info['state']))
		BreakPlayRec(call_info['async_work_ch'])
		call_info['async_work_ch'] = None
		jsonrpc.send_result(sender, id_)
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1657</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.send_dtmf_start ok return</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_result(sender, id_)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1658</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.send_dtmf_start error</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_error(sender, id_)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1663</NodeID>
    <NodeType>INVOKESUB</NodeType>
    <NodeName>调子流程 async send_dtmf</NodeName>
    <ExtendedProperty>SubFlowName=call_async_send_dtmf;InvokeType=1;ChNo=vch;Timeout=;RunMode=0</ExtendedProperty>
    <PropertySet>
      <AffectList />
      <EffectList>
        <valuelist>
          <value>sender</value>
        </valuelist>
        <valuelist>
          <value>id_</value>
        </valuelist>
        <valuelist>
          <value>res_id</value>
        </valuelist>
        <valuelist>
          <value>params</value>
        </valuelist>
      </EffectList>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1658</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1657</target>
        </ExitPort>
        <ExitPort>
          <type>22</type>
          <targetflow>call_async_send_dtmf</targetflow>
          <target>1000</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1828</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 NewVCh and check_state</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		if call_info['state'] not in ['Idle']:
			raise RuntimeError('Can not perform method "%s" on a call whose state is "%s"' % (method, call_info['state']))
		#
		vch = NewVCh()
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1663</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1690</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 send_dtmf stop</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		if call_info['state'] not in ['SendDtmf']:
			raise RuntimeError('Can not perform method "%s" on a call whose state is "%s"' % (method, call_info['state']))
		BreakPlayRec(call_info['async_work_ch'])
		call_info['async_work_ch'] = None
		jsonrpc.send_result(sender, id_)
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1704</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.receive_dtmf_start ok return</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_result(sender, id_)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1705</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.receive_dtmf_start error</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_error(sender, id_)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1710</NodeID>
    <NodeType>INVOKESUB</NodeType>
    <NodeName>调子流程 async receive_dtmf</NodeName>
    <ExtendedProperty>SubFlowName=call_async_receive_dtmf;InvokeType=1;ChNo=vch;Timeout=;RunMode=0</ExtendedProperty>
    <PropertySet>
      <AffectList />
      <EffectList>
        <valuelist>
          <value>sender</value>
        </valuelist>
        <valuelist>
          <value>id_</value>
        </valuelist>
        <valuelist>
          <value>res_id</value>
        </valuelist>
        <valuelist>
          <value>params</value>
        </valuelist>
      </EffectList>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1705</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1704</target>
        </ExitPort>
        <ExitPort>
          <type>22</type>
          <targetflow>call_async_receive_dtmf</targetflow>
          <target>1000</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1829</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 NewVCh and check_state</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		if call_info['state'] not in ['Idle']:
			raise RuntimeError('Can not perform method "%s" on a call whose state is "%s"' % (method, call_info['state']))
		#
		vch = NewVCh()
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1710</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1747</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 receive_dtmf_stop</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		if call_info['state'] not in ['ReceiveDtmf']:
			raise RuntimeError('Can not perform method "%s" on a call whose state is "%s"' % (method, call_info['state']))
		BreakPlayRec(call_info['async_work_ch'])
		call_info['async_work_ch'] = None
		jsonrpc.send_result(sender, id_)
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1766</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.receive_bridge_start ok return</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_result(sender, id_)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1767</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.receive_bridge_start error</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_error(sender, id_)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1772</NodeID>
    <NodeType>INVOKESUB</NodeType>
    <NodeName>调子流程 async bridge</NodeName>
    <ExtendedProperty>SubFlowName=call_async_bridge;InvokeType=1;ChNo=vch;Timeout=;RunMode=0</ExtendedProperty>
    <PropertySet>
      <AffectList />
      <EffectList>
        <valuelist>
          <value>sender</value>
        </valuelist>
        <valuelist>
          <value>id_</value>
        </valuelist>
        <valuelist>
          <value>res_id</value>
        </valuelist>
        <valuelist>
          <value>params</value>
        </valuelist>
      </EffectList>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1767</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1766</target>
        </ExitPort>
        <ExitPort>
          <type>22</type>
          <targetflow>call_async_bridge</targetflow>
          <target>1000</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1830</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 NewVCh and check_state</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		if call_info['state'] not in ['Idle', 'Dial']:
			raise RuntimeError('Can not perform method "%s" on a call whose state is "%s"' % (method, call_info['state']))
		call_res_id = params['call_res_id']
		bridge_call_info = call_map_r[call_res_id]
		if bridge_call_info['state'] not in ['Idle']:
			raise RuntimeError('Can not perform method "%s" on a bridge call whose state is "%s"' % (method, call_info['state']))
		#
		vch = NewVCh()
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1772</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1819</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 bridge_stop</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		if call_info['state'] not in ['Bridge']:
			raise RuntimeError('Can not perform method "%s" on a call whose state is "%s"' % (method, call_info['state']))
		ret_val = BreakConnect(chan, None)
		if ret_val == 1:
			jsonrpc.send_result(sender, id_)
		else:
			raise RuntimeError('BreakConnect(chan=%d) returns %d' % (chan, ret_val))
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1889</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.conf_enter ok return</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_result(sender, id_)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1890</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.conf_enter error</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	jsonrpc.send_error(sender, id_)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1895</NodeID>
    <NodeType>INVOKESUB</NodeType>
    <NodeName>调子流程 async conf</NodeName>
    <ExtendedProperty>SubFlowName=call_async_conf;InvokeType=1;ChNo=vch;Timeout=;RunMode=0</ExtendedProperty>
    <PropertySet>
      <AffectList />
      <EffectList>
        <valuelist>
          <value>sender</value>
        </valuelist>
        <valuelist>
          <value>id_</value>
        </valuelist>
        <valuelist>
          <value>res_id</value>
        </valuelist>
        <valuelist>
          <value>params</value>
        </valuelist>
      </EffectList>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1890</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1889</target>
        </ExitPort>
        <ExitPort>
          <type>22</type>
          <targetflow>call_async_conf</targetflow>
          <target>1000</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1898</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 NewVCh and check_state</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		conf_res_id = params['conf_res_id']
		conf_info = conf_map_r[conf_res_id]
		conf_id = conf_info['conf_id']
		#
		if call_info['state'] not in ['Idle']:
			raise RuntimeError('Can not perform method "%s" on a call whose state is "%s"' % (method, call_info['state']))
		#
		vch = NewVCh()
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1895</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1348</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 exit_conf</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	try:
		conf_res_id = params['conf_res_id']
		conf_info = conf_map_r[conf_res_id]
		conf_id = conf_info['conf_id']
		if call_info['state'] not in ['Conf']:
			raise RuntimeError('Can not perform method "%s" on a call whose state is "%s"' % (method, call_info['state']))
		ret_val = RemoveConfer(conf_id, chan)
		if ret_val == 1:
			jsonrpc.send_result(sender, id_)
		else:
			raise RuntimeError('RemoveConfer(conf_id=%d, chan=%d) returns %d' % (conf_id, chan, ret_val))
	except Exception as err:
		jsonrpc.send_error(sender, id_, message='{}'.format(err))
		raise
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1142</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
</root>