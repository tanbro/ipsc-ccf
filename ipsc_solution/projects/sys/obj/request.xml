<?xml version="1.0" encoding="utf-8"?>
<root>
  <FlowItem>
    <FlowID>request</FlowID>
    <FlowName>request</FlowName>
    <FlowDesc />
    <FlowVer>1.0</FlowVer>
    <CreateDate>2016-06-03T18:04:14+08:00</CreateDate>
    <ModifyDate>2016-06-03T10:07:06+08:00</ModifyDate>
    <DesignVer>2.0</DesignVer>
  </FlowItem>
  <FlowNode>
    <NodeID>1021</NodeID>
    <NodeType>SUBSTART</NodeType>
    <NodeName>子流程开始</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <AffectList>
        <varlist>
          <var>id_</var>
        </varlist>
        <varlist>
          <var>method</var>
        </varlist>
        <varlist>
          <var>params</var>
        </varlist>
      </AffectList>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1062</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1023</NodeID>
    <NodeType>JUDGE</NodeType>
    <NodeName>判断 method</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <switch>
        <case>
          <expression>method == "ivr.call.perform"</expression>
          <ExitType>101</ExitType>
        </case>
      </switch>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>101</type>
          <targetflow>
          </targetflow>
          <target>1074</target>
        </ExitPort>
        <ExitPort>
          <type>100</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1027</NodeID>
    <NodeType>INVOKESUB</NodeType>
    <NodeName>调子流程 call_perform</NodeName>
    <ExtendedProperty>SubFlowName=call_perform;InvokeType=0;ChNo=;Timeout=;RunMode=0</ExtendedProperty>
    <PropertySet>
      <AffectList />
      <EffectList>
        <valuelist>
          <value>call_info</value>
        </valuelist>
      </EffectList>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1068</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1068</target>
        </ExitPort>
        <ExitPort>
          <type>21</type>
          <targetflow>call_perform</targetflow>
          <target>1000</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1057</NodeID>
    <NodeType>DELAY</NodeType>
    <NodeName>延时 next_rpc_req</NodeName>
    <ExtendedProperty>IsCheckHangup=1;Delay=delay_msec;Contect=;WorkCh=chan;OutData=next_rpc_req</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>5</type>
          <targetflow>
          </targetflow>
          <target>1090</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1066</target>
        </ExitPort>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1062</NodeID>
    <NodeType>LET</NodeType>
    <NodeName>赋值</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <letlist>
        <let>
          <VarName>delay_msec</VarName>
          <ZoneType>0</ZoneType>
          <Value>15000</Value>
        </let>
        <let>
          <VarName>last_err</VarName>
          <ZoneType>0</ZoneType>
          <Value>None</Value>
        </let>
      </letlist>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1023</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1066</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 next_rpc_req</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=id_, method, params = next_rpc_req</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1023</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1068</NodeID>
    <NodeType>JUDGE</NodeType>
    <NodeName>判断 answered</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <switch>
        <case>
          <expression>call_info['answer_time']</expression>
          <ExitType>101</ExitType>
        </case>
      </switch>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>101</type>
          <targetflow>
          </targetflow>
          <target>1089</target>
        </ExitPort>
        <ExitPort>
          <type>100</type>
          <targetflow>
          </targetflow>
          <target>1090</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1074</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call initiate</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=cid_map = _gd_['cid_map']
cid_rmap = _gd_['cid_rmap']
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1076</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1076</NodeID>
    <NodeType>DIALEX</NodeType>
    <NodeName>拨号</NodeName>
    <ExtendedProperty>WorkCh=;Dnis=params['to_uri'];Ani=params['from_uri'];OrDnis=;AgConnDelay=6;IsConnCh=1;RingVoice=;RingTimeout=50;IsStopPlay=1;IsCheckDialTone=0;OutChNo=chan;OutDnis=;LinkNo=;PlayType=;CallDevGroup=;CallDev=;InteractiveMode=0;CallDevType=2;DtmfTime=10;Option=;WorkDev2=0;OutSessionID=;OutConnCh=;EndMode=1;IsM3G=0</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>6</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>4</type>
          <targetflow>
          </targetflow>
          <target>1079</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1078</target>
        </ExitPort>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1079</target>
        </ExitPort>
        <ExitPort>
          <type>5</type>
          <targetflow>
          </targetflow>
          <target>1079</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1078</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本::call.perform initiated</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	cid = uuid()
	Trace('1')
	cid_map[cid] = call_info = {
		'id': id_,
		'cid': cid,
		'params': params,
		'chan': chan,
		'begin_time': now(),
		'answer_time': None,
		'end_time': None,
		'dropped_by': 'usr',
		'reason': None,
		'cause': None,
	}
	cid_rmap[chan] = cid
	jsonrpc.send_result(id_, cid)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1109</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1079</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本::call.perform error</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	cid_map.pop(cid, None)
	cid_rmap.pop(chan, None)
	jsonrpc.send_error(id_)
except IvrError as err:
	TraceErr(err)
	last_err = err</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1089</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.on_answer</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=jsonrpc.send_method(
	method='ivr.call.on_answered',
	params={
		'cid': cid,
	}
)
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1057</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1090</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call.on_finished</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=cid_map.pop(cid)
cid_rmap.pop(chan)

call_info['end_time'] = now()
call_info['reason'], call_info['cause'] = GetCallFailReasonAndCause(chan)

if call_info['answer_time']:
	answered_duration = call_info['end_time'] - call_info['answer_time']
else:
	answered_duration = None

jsonrpc.send_method(
	method='ivr.call.on_finished',
	params={
		'cid': call_info['cid'],
		'dropped_by': call_info['dropped_by'],
		'cause': call_info['cause'],
		'answered_duration': answered_duration,
	}
)
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1109</NodeID>
    <NodeType>JUDGE</NodeType>
    <NodeName>判断 not last_err</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <switch>
        <case>
          <expression>not bool(last_err)</expression>
          <ExitType>101</ExitType>
        </case>
      </switch>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>101</type>
          <targetflow>
          </targetflow>
          <target>1027</target>
        </ExitPort>
        <ExitPort>
          <type>100</type>
          <targetflow>
          </targetflow>
          <target>1079</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
</root>