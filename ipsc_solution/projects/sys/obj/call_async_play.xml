<?xml version="1.0" encoding="utf-8"?>
<root>
  <FlowItem>
    <FlowID>call_async_play</FlowID>
    <FlowName>call_async_play</FlowName>
    <FlowDesc />
    <FlowVer>1.0</FlowVer>
    <CreateDate>2016-06-17T13:39:07+08:00</CreateDate>
    <ModifyDate>2016-09-01T10:24:17+08:00</ModifyDate>
    <DesignVer>2.0</DesignVer>
  </FlowItem>
  <FlowNode>
    <NodeID>1489</NodeID>
    <NodeType>SUBSTART</NodeType>
    <NodeName>子流程开始</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <AffectList>
        <varlist>
          <var>sender</var>
        </varlist>
        <varlist>
          <var>id_</var>
        </varlist>
        <varlist>
          <var>res_id</var>
        </varlist>
        <varlist>
          <var>params</var>
        </varlist>
      </AffectList>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1490</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1490</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=error = None
finish_key = None

last_err = None

call_map = _gd_['call_map'] # chan =&gt; call_info
conf_map = _gd_['conf_map'] # res_id =&gt; call_info

call_map_r = _gd_['call_map_r'] # res_id =&gt; call_info
conf_map_r = _gd_['conf_map_r'] # res_id -&gt; conf_info

#
call_info = call_map_r[res_id]
chan = call_info['chan']

#
begin_time = now()
call_info['async_work_ch'] = GetCurrentCh()
call_info['state'] = 'Play'

#
cl = []
content = params['content']
if isinstance(content, str):
	cl.append([content, 0, ''])
elif isinstance(content, (list,tuple)):
	for item in content[0:29]:
		if len(item) &lt; 3:
			item[2] = ''
		cl.append([str(item[0]), int(item[1]), str(item[2])])
cl.append([None, 0, ""])
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1639</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1492</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1492</NodeID>
    <NodeType>PLAY</NodeType>
    <NodeName>放音</NodeName>
    <ExtendedProperty>PrePromptVoice=;ChNo=chan;BreakDtmfStr=params.get('finish_keys');Mode=0;OutKey=finish_key;VideoFile=;VideoFormat=0;PlayVideoVoice=0;PlayEndMode=0;IsHaveLogo=0;LogoFile=;LogoPosLeft=0;LogoPosTop=0;LogoWidth=0;LogoHeight=0;LogoTransYUVA=255:255:255:0;LogoAlphaBlending=0</ExtendedProperty>
    <PropertySet>
      <DynamicVoice>
        <VarVoice>
          <content>cl[0][0]</content>
          <type>cl[0][1]</type>
          <option>cl[0][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[1][0]</content>
          <type>cl[1][1]</type>
          <option>cl[1][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[2][0]</content>
          <type>cl[2][1]</type>
          <option>cl[2][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[3][0]</content>
          <type>cl[3][1]</type>
          <option>cl[3][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[4][0]</content>
          <type>cl[4][1]</type>
          <option>cl[4][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[5][0]</content>
          <type>cl[5][1]</type>
          <option>cl[5][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[6][0]</content>
          <type>cl[6][1]</type>
          <option>cl[6][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[7][0]</content>
          <type>cl[7][1]</type>
          <option>cl[7][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[8][0]</content>
          <type>cl[8][1]</type>
          <option>cl[8][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[9][0]</content>
          <type>cl[9][1]</type>
          <option>cl[9][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[10][0]</content>
          <type>cl[10][1]</type>
          <option>cl[10][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[11][0]</content>
          <type>cl[11][1]</type>
          <option>cl[12][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[12][0]</content>
          <type>cl[12][1]</type>
          <option>cl[12][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[13][0]</content>
          <type>cl[13][1]</type>
          <option>cl[13][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[14][0]</content>
          <type>cl[14][1]</type>
          <option>cl[14][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[15][0]</content>
          <type>cl[15][1]</type>
          <option>cl[15][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[16][0]</content>
          <type>cl[16][1]</type>
          <option>cl[16][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[17][0]</content>
          <type>cl[17][1]</type>
          <option>cl[17][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[18][0]</content>
          <type>cl[18][1]</type>
          <option>cl[18][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[19][0]</content>
          <type>cl[19][1]</type>
          <option>cl[19][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[20][0]</content>
          <type>cl[20][1]</type>
          <option>cl[20][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[21][0]</content>
          <type>cl[21][1]</type>
          <option>cl[21][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[22][0]</content>
          <type>cl[22][1]</type>
          <option>cl[22][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[23][0]</content>
          <type>cl[23][1]</type>
          <option>cl[23][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[24][0]</content>
          <type>cl[24][1]</type>
          <option>cl[24][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[25][0]</content>
          <type>cl[25][1]</type>
          <option>cl[25][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[26][0]</content>
          <type>cl[26][1]</type>
          <option>cl[26][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[27][0]</content>
          <type>cl[27][1]</type>
          <option>cl[27][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[28][0]</content>
          <type>cl[28][1]</type>
          <option>cl[28][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[29][0]</content>
          <type>cl[29][1]</type>
          <option>cl[29][2]</option>
        </VarVoice>
        <VarVoice>
          <content>cl[30][0]</content>
          <type>cl[30][1]</type>
          <option>cl[30][2]</option>
        </VarVoice>
      </DynamicVoice>
      <SubTitle />
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1634</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>5</type>
          <targetflow>
          </targetflow>
          <target>1636</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1494</NodeID>
    <NodeType>AFTERPROC</NodeType>
    <NodeName>后处理</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1503</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1499</NodeID>
    <NodeType>SUBEND</NodeType>
    <NodeName>子流程结束</NodeName>
    <ExtendedProperty>IsHangup=1</ExtendedProperty>
    <PropertySet>
      <EffectList />
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1503</NodeID>
    <NodeType>SCRIPT</NodeType>
    <NodeName>脚本 call on play completed</NodeName>
    <ExtendedProperty>ZoneType=0;ScriptContent=last_err = None
try:
	call_info['async_work_ch'] = None
	call_info['state'] = 'Idle'
	params = {
			'res_id': res_id,
			'error': error,
			'begin_time': begin_time,
			'end_time': now(),
			'finish_key': finish_key,
			'user_data': call_info['params'].get('user_data'),
		}
	jsonrpc.send_event(
		method='call.on_play_completed',
		params=params
	)
except IvrError as err:
	TraceErr(err)
	last_err = err
</ExtendedProperty>
    <PropertySet>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>1499</target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>1499</target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1634</NodeID>
    <NodeType>LET</NodeType>
    <NodeName>赋值 error</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <letlist>
        <let>
          <VarName>error</VarName>
          <ZoneType>0</ZoneType>
          <Value>"play error"</Value>
        </let>
      </letlist>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1636</NodeID>
    <NodeType>LET</NodeType>
    <NodeName>赋值 error</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <letlist>
        <let>
          <VarName>error</VarName>
          <ZoneType>0</ZoneType>
          <Value>"hungup when playing"</Value>
        </let>
      </letlist>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
  <FlowNode>
    <NodeID>1639</NodeID>
    <NodeType>LET</NodeType>
    <NodeName>赋值 error</NodeName>
    <ExtendedProperty>
    </ExtendedProperty>
    <PropertySet>
      <letlist>
        <let>
          <VarName>error</VarName>
          <ZoneType>0</ZoneType>
          <Value>'unknown'</Value>
        </let>
      </letlist>
      <Exit>
        <ExitPort>
          <type>2</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
        <ExitPort>
          <type>1</type>
          <targetflow>
          </targetflow>
          <target>
          </target>
        </ExitPort>
      </Exit>
    </PropertySet>
  </FlowNode>
</root>